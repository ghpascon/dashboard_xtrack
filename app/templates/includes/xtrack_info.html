<div class="flex flex-col m-3 mx-3 p-3 items-start mb-6">
  <div class="flex flex-row items-center justify-between w-full">
    <button
      id="trigger-update-btn"
      class="bg-[#FF5722] hover:bg-[#e64a19] text-white font-semibold px-4 py-2 rounded-lg shadow transition"
    >
      Atualizar dados agora
    </button>
    <span class="text-sm text-gray-600 bg-[#FFF3E0] rounded px-3 py-1">
      Próximo refresh em <span id="refresh-timer"></span>s
    </span>
  </div>
  <div
    id="update-msg"
    class="text-sm text-[#FF5722] font-semibold mt-2 mb-2"
    style="display: none"
  ></div>
</div>
<div
  id="xtrack-dashboard"
  class="mx-auto m-3 mx-3 p-3 bg-white rounded-2xl shadow-lg border border-gray-200 flex flex-col md:flex-row gap-8 justify-center items-start"
>
  <!-- Objetos à esquerda -->
  <div class="w-full max-w-lg mx-auto md:mx-0 md:w-1/2">
    <div class="w-full flex flex-row items-center justify-between mb-8">
      <h2 class="text-2xl font-bold text-[#FF5722]">Dashboard</h2>
    </div>
    <div
      id="update-msg"
      class="text-sm text-[#FF5722] font-semibold mb-4"
      style="display: none"
    ></div>
    <div class="mb-8">
      <div
        class="bg-[#FF5722] border border-[#FFAB91] text-white rounded-2xl px-8 py-6 flex flex-col items-center shadow-md mb-6"
      >
        <span class="font-semibold text-xl mb-2"
          >Total de malotes em estoque</span
        >
        <span id="objects-count" class="text-5xl font-bold mt-1">-</span>
      </div>
      <div
        id="objects-location-list"
        class="w-full grid grid-cols-1 sm:grid-cols-2 gap-4"
      >
        <!-- Locais preenchidos via JS -->
      </div>
    </div>
  </div>
  <!-- Movimentações à direita -->
  <div class="w-full max-w-lg mx-auto md:mx-0 md:w-1/2">
    <div class="w-full flex flex-row items-center justify-between mb-8">
      <h2 class="text-2xl font-bold text-[#1976D2]">Movimentações</h2>
    </div>
    <div class="mb-8">
      <div class="flex flex-row gap-4 mb-6">
        <div
          class="flex-1 bg-[#1976D2] border border-[#90CAF9] text-white rounded-2xl px-8 py-6 flex flex-col items-center shadow-md"
        >
          <span class="font-semibold text-xl mb-2">Total de movimentações</span>
          <span id="movements-count" class="text-5xl font-bold mt-1">-</span>
        </div>
        <div
          class="flex-1 bg-[#E3F2FD] border border-[#90CAF9] text-[#1976D2] rounded-2xl px-8 py-6 flex flex-col items-center shadow-md"
        >
          <span class="font-semibold text-base mb-1">Movimentações hoje</span>
          <span id="movements-today" class="text-3xl font-bold mt-1">-</span>
        </div>
      </div>
      <div>
        <div
          id="movements-by-location-list"
          class="w-full grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2"
        >
          <!-- Locais preenchidos via JS -->
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  let refreshInterval = 300; // segundos
  let timer = refreshInterval;
  const timerSpan = document.getElementById("refresh-timer");

  function updateTimer() {
    timer--;
    if (timer <= 0) {
      fetchData();
      timer = refreshInterval;
    }
    timerSpan.textContent = timer;
  }

  async function triggerXtrackUpdate() {
    const btn = document.getElementById("trigger-update-btn");
    const msg = document.getElementById("update-msg");
    btn.disabled = true;
    msg.textContent =
      "Atualização solicitada! Os dados serão atualizados em até 10 segundos...";
    msg.style.display = "block";
    try {
      await fetch("{{ url_for('trigger_xtrack_update') }}", {
        method: "POST",
      });
    } catch {}
    setTimeout(() => {
      fetchData();
      btn.disabled = false;
      msg.textContent = "Dados atualizados!";
      setTimeout(() => {
        msg.style.display = "none";
      }, 4000);
    }, 10000);
  }
  async function fetchData() {
    try {
      const resp = await fetch("{{ url_for('get_xtrack_info') }}");
      if (!resp.ok) throw new Error("Erro ao buscar dados");
      const data = await resp.json();
      // Objetos
      document.getElementById("objects-count").textContent = data.objects_count;
      const list = document.getElementById("objects-location-list");
      list.innerHTML = "";
      for (const [loc, count] of Object.entries(data.objects_in_locations)) {
        const label = loc === "null" ? "(Sem local)" : loc;
        const card = document.createElement("div");
        card.className =
          "bg-[#FFF3E0] border border-[#FFAB91] rounded-2xl px-6 py-4 flex flex-col items-center shadow-md";
        card.innerHTML = `
          <span class="text-[#FF5722] font-semibold text-base mb-2">${label}</span>
          <span class="text-2xl font-bold text-[#FF5722]">${count}</span>
        `;
        list.appendChild(card);
      }
      // Movimentações
      document.getElementById("movements-count").textContent =
        data.movements_count;
      document.getElementById("movements-today").textContent =
        data.movements_today;
      const movList = document.getElementById("movements-by-location-list");
      movList.innerHTML = "";
      for (const [loc, count] of Object.entries(data.movements_by_location)) {
        const label = loc === "null" ? "(Sem local)" : loc;
        const card = document.createElement("div");
        card.className =
          "bg-white border border-[#90CAF9] rounded-xl px-6 py-3 flex flex-row items-center shadow-sm";
        card.innerHTML = `
          <span class="flex-1 text-[#1976D2] font-semibold text-base">${label}</span>
          <span class="text-xl font-bold text-[#1976D2]">${count}</span>
        `;
        movList.appendChild(card);
      }
    } catch (e) {
      document.getElementById("locations-count").textContent = "-";
      document.getElementById("objects-count").textContent = "-";
      document.getElementById("objects-in-locations").innerHTML =
        '<tr><td colspan="2" class="text-red-500">Erro ao carregar dados</td></tr>';
    }
  }

  // Inicializa
  fetchData();
  setInterval(updateTimer, 1000);
  document
    .getElementById("trigger-update-btn")
    .addEventListener("click", triggerXtrackUpdate);
</script>
